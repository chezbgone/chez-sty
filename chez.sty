\ProvidesPackage{chez}

\newif\ifchez@date        \chez@datetrue
\newif\ifchez@sf          \chez@sftrue
\newif\ifchez@header      \chez@headerfalse
\newif\ifchez@gray        \chez@grayfalse
\newif\ifchez@box         \chez@boxtrue
\newif\ifchez@algos       \chez@algosfalse
\newif\ifchez@asy         \chez@asyfalse
\newif\ifchez@code        \chez@codefalse
\newif\ifchez@compact     \chez@compactfalse
\newif\ifchez@marginnum   \chez@marginnumtrue
\newif\ifchez@sepcounters \chez@sepcountersfalse

\DeclareOption{nodate}{\chez@datefalse}
\DeclareOption{serif}{\chez@sffalse}
\DeclareOption{header}{\chez@headertrue}
\DeclareOption{gray}{\chez@graytrue}
\DeclareOption{nobox}{\chez@boxfalse}
\DeclareOption{asy}{\chez@asytrue}
\DeclareOption{algos}{\chez@algostrue}
\DeclareOption{code}{\chez@codetrue\chez@algostrue}
\DeclareOption{compact}{\chez@compacttrue}
\DeclareOption{nomarginnum}{\chez@marginnumfalse}
\DeclareOption{sepcounters}{\chez@sepcounterstrue}

\ProcessOptions*

\KOMAoptions{
	paper=letter,
	fontsize=10pt,
	DIV=18,
	numbers=noendperiod,
}

% General
\ifchez@gray\PassOptionsToPackage{gray}{xcolor}\fi
\RequirePackage{chezbase}

% Typography
\RequirePackage{lmodern}
\ifchez@sf\RequirePackage[defaultsans, scale=0.95]{lato}\fi
\RequirePackage{microtype}
\RequirePackage[nodisplayskipstretch, onehalfspacing]{setspace}

% Headers
\ifchez@header\RequirePackage{scrlayer-scrpage}\fi

% Compact Option
\ifchez@compact\RequirePackage[extreme]{savetrees}\fi

% Diagrams
\RequirePackage{tikz}
\usetikzlibrary{calc, cd, math, positioning}
\ifchez@asy\RequirePackage[inline]{asymptote}\fi

% Macros
\RequirePackage[shortlabels, inline]{enumitem}

% Theorem Boxes
\ifchez@box\RequirePackage{tcolorbox}\fi

% Algorithms/Code
\ifchez@algos\RequirePackage[noend]{algpseudocode}\fi
\ifchez@code\RequirePackage{minted}\fi

\PassOptionsToPackage{pdftex, pdfcreator={LaTeX with chez.sty by Jason Chen}}{hyperref}
\ifchez@gray
	\RequirePackage{hyperref}
\else
	\RequirePackage[colorlinks]{hyperref} % load this last generally
	\definecolor{urlcolor}{rgb}{0.9, 0, 0.5}
	\definecolor{citecolor}{rgb}{0, 0.6, 0.3}
	\hypersetup{urlcolor=urlcolor, linkcolor=blue, citecolor=citecolor}
\fi

% cleverref must be loaded after hyperref
% also is really picky and wants to be loaded after everything
\RequirePackage{cleveref}

% SETUP
\author{Jason Chen}

\ifchez@date\else\date{~\vspace{-3em}}\fi

% Stylize things
\patchcmd{\@maketitle}{\huge}{\large}{}{}
\setkomafont{author}{\normalsize\scshape}
\setkomafont{date}{\normalsize}
\ifchez@sf\else\setkomafont{disposition}{\normalcolor\bfseries}\fi
\ifchez@header\setkomafont{pageheadfoot}{\normalcolor}\fi
\RedeclareSectionCommand[beforeskip=0.4\baselineskip]{paragraph}

% Section numbers in the margin
\ifchez@marginnum
	\RenewDocumentCommand{\sectionlinesformat}{m m m m}{\makebox[0pt][r]{#3}#4}
\fi

% Compact title
\ifchez@compact\patchcmd{\@maketitle}{\large}{\large\sffamily}\fi

\allowdisplaybreaks
\AtBeginDocument{
	\setlength{\belowdisplayskip}{0.5em}
	\setlength{\belowdisplayshortskip}{0.2em}
	\setlength{\abovedisplayskip}{0.5em}
	\setlength{\abovedisplayshortskip}{0.2em}
}

\RenewDocumentCommand{\arraystretch}{}{0.8}
\setlist{noitemsep, topsep=0.4em, listparindent=\parindent}

% Make itemize bullets smaller
\RenewDocumentCommand{\labelitemi}{}{$\vcenter{\hbox{\tiny\textbullet}}$}

% Better default bracket width/height
\let\oldunderbracket\underbracket
\RenewDocumentCommand{\underbracket}{O{0.12ex} O{0.6ex} m}{\oldunderbracket[#1][#2]{#3}}

% Theorem boxes (Heavily copied from DZhu)
\ifchez@box
	\tcbuselibrary{skins, theorems, xparse, breakable}
	\newcommand*{\chez@drawmarginnumber}[1]{
		\node[anchor=north east,
			inner sep=0pt,
			xshift=-0.8em,
			yshift=-1.865ex,
			font=\sffamily\bfseries\color{tcbcoltitle}\mathstrut\small] at (frame.north west)
		{#1};
	}
	\tcbset{
		chezbox/.style={
			enhanced jigsaw,
			breakable,
			fonttitle=\sffamily\bfseries,
			sharp corners,
			boxrule=0pt,
			leftrule=2pt,
			left=5pt,
			coltitle=black,
			attach title to upper=\par,
		},
		chezbluebox/.style={
			chezbox,
			coltitle=blue!80!black,
			colframe=blue!80,
			colback=blue!7,
		},
		chezgreenbox/.style={
			chezbox,
			coltitle=green!40!black,
			colframe=green!70!black,
			colback=green!7,
		},
		chezorangebox/.style={
			chezbox,
			coltitle=orange!80!black,
			colframe=orange!98!black,
			colback=orange!8,
		},
		chezredbox/.style={
			chezbox,
			coltitle=red!60!black,
			colframe=red!80!black,
			colback=red!7,
		},
	}
	\tcbset{
		chezthm/.style={
			theorem style=break,
			separator sign none,
			description delimiters parenthesis,
			description font=\normalfont\sffamily\small,
			terminator sign none,
		},
		chezthmmargin/.style={
			enhanced jigsaw,
			theorem name,
			extras unbroken and first={
				overlay={
					\ifdef{\thetcbthmcounter}{
						\chez@drawmarginnumber{\thetcbthmcounter}
					}{
						\ifdef{\thetcbcounter}{\chez@drawmarginnumber{\thetcbcounter}}
					}
				},
			},
		},
		chezbluethm/.style={chezbluebox, chezthm},
		chezgreenthm/.style={chezgreenbox, chezthm},
		chezorangethm/.style={chezorangebox, chezthm},
		chezredthm/.style={chezredbox, chezthm},
	}

	\ifchez@marginnum
		\tcbset{chezthm/.append style=chezthmmargin}
	\fi

	% Better theorem declaration syntax (from DZhu)
	\renewcommand{\new@tcbtheorem}[5][]{%
		\@@newtcolorbox[auto counter,#1]{#2}{O{} D<>{}}{#4,%
			title={\tcb@theo@title{#3}{\thetcbcounter}{##1}},%
			list entry={\protect\numberline{\thetcbcounter}##1},%
			nameref={##1},%
			code={\tcb@theo@label{#5}{##2}},%
		}%
		\@@newtcolorbox[#1,no counter,list inside=]{#2*}{O{}}{#4,%
			title={\tcb@theo@title{#3}{\@empty}{##1}},%
		}%
	}
	\def\newtcbtheorem{\let\@@newtcolorbox\NewTColorBox%
		\new@tcbtheorem}
	\def\renewtcbtheorem{\let\@@newtcolorbox\RenewTColorBox%
		\new@tcbtheorem}
	
	\newcommand*\zbs@newtheorem[4]{
		\newtcbtheorem[use counter*=#3]{#1}{#2}{#4}{#1}
	}
	
	\newcommand*\zbs@numberwithin[2]{
		\ifx#2\zbs@empty\else\numberwithin{#1}{#2}\fi
	}
	\newcounter{cthm} \zbs@numberwithin{cthm}{\zbs@thm@numberwithin}
	\newcommand\zbs@thmctrmain{cthm}
	\ifchez@sepcounters
		\newcounter{cprob} \zbs@numberwithin{cprob}{\zbs@thm@numberwithinalt}
		\newcommand\zbs@thmctralt{cprob}
	\else
		\newcommand\zbs@thmctralt{cthm}
	\fi

	\NewDocumentCommand\zbsnewtheorem{s m m m}{
		\zbs@newtheorem{#2}{#3}{\IfBooleanTF{#1}{\zbs@thmctralt}{\zbs@thmctrmain}}{#4}
	}

	\zbsnewtheorem{theorem}{Theorem}{chezbluethm}
	\zbsnewtheorem{lemma}{Lemma}{chezbluethm}
	\zbsnewtheorem{claim}{Claim}{chezbluethm}
	\zbsnewtheorem{proposition}{Proposition}{chezbluethm}
	\zbsnewtheorem{corollary}{Corollary}{chezbluethm}
	\zbsnewtheorem{conjecture}{Conjecture}{chezbluethm}
	\zbsnewtheorem{algorithm}{Algorithm}{chezbluethm}

	\zbsnewtheorem{definition}{Definition}{chezredthm}

	\zbsnewtheorem{example}{Example}{chezgreenthm}

	\zbsnewtheorem{fact}{Fact}{chezorangethm}
	\zbsnewtheorem{note}{Note}{chezorangethm}

	\zbsnewtheorem*{exercise}{Exercise}{chezorangethm}
	\zbsnewtheorem*{remark}{Remark}{chezorangethm}

	% TODO: non-box case
	% TODO: non-color case
	% TODO: cleverref integration
\fi

% Algorithms
\ifchez@algos
	\NewDocumentCommand{\ElseIf}{}{\ElsIf}

	% Fix https://tex.stackexchange.com/questions/177025/ issue with
	% hyperref, cleverref, and algpseudocode
	\newcounter{algorithmicH} % New algorithmic-like hyperref counter
	\let\oldalgorithmic\algorithmic
	\RenewDocumentCommand{\algorithmic}{}{%
		\stepcounter{algorithmicH}%
		\oldalgorithmic}%
	\NewDocumentCommand{\theHALG@line}{}{ALG@line.\thealgorithmicH.\arabic{ALG@line}}
\fi

\ifchez@code\setminted{linenos=true, breaklines=true, tabsize=4}\fi
